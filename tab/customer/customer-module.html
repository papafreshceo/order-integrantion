<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>고객관리</title>
    <style>
        .customer-container {
            padding: 20px;
        }
        
        .customer-search {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .customer-stats {
            margin-bottom: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .summary-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 300;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 500;
            color: #212529;
        }
        
        .customer-grade-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
        }
        
        .grade-vip {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .grade-regular {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .grade-new {
            background: #d1fae5;
            color: #10b981;
        }
        
        .grade-dormant {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .customer-form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .customer-form-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 700px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .purchase-history {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="customer-container">
        <!-- 고객 검색 섹션 -->
        <div class="section-container">
            <h2 class="section-title">
                <div class="section-title-text">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    고객 검색
                </div>
            </h2>
            
            <div class="customer-search">
                <div class="form-row-custom">
                    <div class="form-group" style="width: 150px;">
                        <label>고객등급</label>
                        <select id="customerGrade" class="form-input-direct">
                            <option value="">전체</option>
                            <option value="VIP">VIP</option>
                            <option value="일반">일반</option>
                            <option value="신규">신규</option>
                            <option value="휴면">휴면</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>검색구분</label>
                        <select id="searchType" class="form-input-direct">
                            <option value="name">고객명</option>
                            <option value="phone">연락처</option>
                            <option value="email">이메일</option>
                            <option value="address">주소</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 250px;">
                        <label>검색어</label>
                        <input type="text" id="searchKeyword" class="form-input-direct" placeholder="검색어를 입력하세요">
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>가입일자(시작)</label>
                        <input type="date" id="joinDateFrom" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>가입일자(종료)</label>
                        <input type="date" id="joinDateTo" class="form-input-direct">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn-verify" onclick="CustomerModule.searchCustomers()">검색</button>
                        <button class="btn-reset" onclick="CustomerModule.resetSearch()">초기화</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 고객 통계 섹션 -->
        <div class="section-container">
            <h2 class="section-title">
                <div class="section-title-text">
                    고객 현황
                </div>
            </h2>
            
            <div class="customer-stats">
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-label">전체 고객</div>
                        <div class="summary-value" id="totalCustomers">0명</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">VIP 고객</div>
                        <div class="summary-value" id="vipCustomers" style="color: #f59e0b;">0명</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">신규 고객(이번달)</div>
                        <div class="summary-value" id="newCustomers" style="color: #10b981;">0명</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">휴면 고객</div>
                        <div class="summary-value" id="dormantCustomers" style="color: #6c757d;">0명</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 고객 목록 섹션 -->
        <div class="section-container">
            <h2 class="section-title">
                <div class="section-title-text">
                    고객 목록
                </div>
                <div class="export-buttons">
                    <button class="btn-add-order" style="margin-right: 10px;" onclick="CustomerModule.openAddForm()">고객 등록</button>
                    <button class="export-btn export-excel" onclick="CustomerModule.exportExcel()">엑셀 다운로드</button>
                </div>
            </h2>
            
            <div class="table-wrapper">
                <table class="order-table" id="customerTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">번호</th>
                            <th style="width: 80px;">등급</th>
                            <th style="width: 100px;">고객명</th>
                            <th style="width: 120px;">연락처</th>
                            <th style="width: 150px;">이메일</th>
                            <th style="width: 250px;">주소</th>
                            <th style="width: 80px;">구매횟수</th>
                            <th style="width: 120px;">총구매액</th>
                            <th style="width: 100px;">최근구매</th>
                            <th style="width: 100px;">가입일</th>
                            <th style="width: 120px;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <tr>
                            <td colspan="11" class="text-center">데이터가 없습니다</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 고객 등록/수정 모달 -->
    <div id="customerFormModal" class="customer-form-modal">
        <div class="customer-form-content">
            <h3 id="formTitle">고객 등록</h3>
            
            <div class="form-row-custom">
                <div class="form-group" style="width: 150px;">
                    <label>고객명 <span class="required">*</span></label>
                    <input type="text" id="formName" class="form-input-direct">
                </div>
                <div class="form-group" style="width: 150px;">
                    <label>연락처 <span class="required">*</span></label>
                    <input type="tel" id="formPhone" class="form-input-direct">
                </div>
                <div class="form-group" style="width: 200px;">
                    <label>이메일</label>
                    <input type="email" id="formEmail" class="form-input-direct">
                </div>
                <div class="form-group" style="width: 120px;">
                    <label>등급</label>
                    <select id="formGrade" class="form-input-direct">
                        <option value="신규">신규</option>
                        <option value="일반">일반</option>
                        <option value="VIP">VIP</option>
                        <option value="휴면">휴면</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row-custom">
                <div class="form-group" style="width: 100px;">
                    <label>우편번호</label>
                    <input type="text" id="formZipcode" class="form-input-direct">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>주소</label>
                    <input type="text" id="formAddress" class="form-input-direct">
                </div>
            </div>
            
            <div class="form-row-custom">
                <div class="form-group" style="width: 100px;">
                    <label>생년월일</label>
                    <input type="date" id="formBirthday" class="form-input-direct">
                </div>
                <div class="form-group" style="width: 100px;">
                    <label>성별</label>
                    <select id="formGender" class="form-input-direct">
                        <option value="">선택</option>
                        <option value="M">남성</option>
                        <option value="F">여성</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>메모</label>
                    <input type="text" id="formMemo" class="form-input-direct">
                </div>
            </div>
            
            <div id="purchaseHistorySection" class="purchase-history" style="display: none;">
                <h4>구매 이력</h4>
                <div id="purchaseHistoryContent">
                    <!-- 구매 이력이 여기에 표시됨 -->
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn-verify" onclick="CustomerModule.saveCustomer()">저장</button>
                <button class="btn-reset" onclick="CustomerModule.closeForm()">취소</button>
            </div>
        </div>
    </div>
    
    <script>
        const CustomerModule = {
            customers: [],
            currentEditId: null,
            
            init: function() {
                console.log('Customer Module initialized');
                this.loadCustomers();
                this.updateStatistics();
                this.setupEventListeners();
            },
            
            setupEventListeners: function() {
                // 전화번호 자동 포맷
                document.getElementById('formPhone').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length >= 4 && value.length <= 7) {
                        if (value.substring(0, 2) === '02') {
                            value = value.substring(0, 2) + '-' + value.substring(2);
                        } else {
                            value = value.substring(0, 3) + '-' + value.substring(3);
                        }
                    } else if (value.length >= 8) {
                        if (value.substring(0, 2) === '02') {
                            if (value.length <= 9) {
                                value = value.substring(0, 2) + '-' + value.substring(2, 5) + '-' + value.substring(5);
                            } else {
                                value = value.substring(0, 2) + '-' + value.substring(2, 6) + '-' + value.substring(6, 10);
                            }
                        } else {
                            if (value.length <= 10) {
                                value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
                            } else {
                                value = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
                            }
                        }
                    }
                    e.target.value = value;
                });
                
                // 검색어 입력시 엔터키 처리
                document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchCustomers();
                    }
                });
            },
            
            loadCustomers: function() {
                const saved = localStorage.getItem('customers');
                if (saved) {
                    this.customers = JSON.parse(saved);
                    this.renderTable();
                }
            },
            
            saveCustomersData: function() {
                localStorage.setItem('customers', JSON.stringify(this.customers));
            },
            
            updateStatistics: function() {
                const total = this.customers.length;
                const vip = this.customers.filter(c => c.grade === 'VIP').length;
                const dormant = this.customers.filter(c => c.grade === '휴면').length;
                
                // 이번달 신규 고객
                const thisMonth = new Date();
                const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
                const newThisMonth = this.customers.filter(c => {
                    const joinDate = new Date(c.joinDate);
                    return joinDate >= monthStart;
                }).length;
                
                document.getElementById('totalCustomers').textContent = total + '명';
                document.getElementById('vipCustomers').textContent = vip + '명';
                document.getElementById('newCustomers').textContent = newThisMonth + '명';
                document.getElementById('dormantCustomers').textContent = dormant + '명';
            },
            
            renderTable: function(filteredData = null) {
                const tbody = document.getElementById('customerTableBody');
                const data = filteredData || this.customers;
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center">데이터가 없습니다</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((customer, index) => {
                    const gradeBadge = this.getGradeBadge(customer.grade);
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${gradeBadge}</td>
                            <td>${customer.name}</td>
                            <td>${customer.phone}</td>
                            <td>${customer.email || '-'}</td>
                            <td>${customer.address || '-'}</td>
                            <td class="text-center">${customer.purchaseCount || 0}</td>
                            <td class="text-right">${(customer.totalPurchase || 0).toLocaleString()}</td>
                            <td>${customer.lastPurchase || '-'}</td>
                            <td>${customer.joinDate}</td>
                            <td>
                                <button class="btn-sm" onclick="CustomerModule.viewCustomer(${customer.id})">상세</button>
                                <button class="btn-sm" onclick="CustomerModule.editCustomer(${customer.id})">수정</button>
                                <button class="btn-sm btn-danger" onclick="CustomerModule.deleteCustomer(${customer.id})">삭제</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            getGradeBadge: function(grade) {
                const badges = {
                    'VIP': '<span class="customer-grade-badge grade-vip">VIP</span>',
                    '일반': '<span class="customer-grade-badge grade-regular">일반</span>',
                    '신규': '<span class="customer-grade-badge grade-new">신규</span>',
                    '휴면': '<span class="customer-grade-badge grade-dormant">휴면</span>'
                };
                return badges[grade] || '';
            },
            
            openAddForm: function() {
                this.currentEditId = null;
                document.getElementById('formTitle').textContent = '고객 등록';
                document.getElementById('purchaseHistorySection').style.display = 'none';
                this.resetForm();
                document.getElementById('formGrade').value = '신규';
                document.getElementById('customerFormModal').style.display = 'flex';
            },
            
            editCustomer: function(id) {
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.currentEditId = id;
                    document.getElementById('formTitle').textContent = '고객 수정';
                    
                    // 폼에 데이터 채우기
                    document.getElementById('formName').value = customer.name;
                    document.getElementById('formPhone').value = customer.phone;
                    document.getElementById('formEmail').value = customer.email || '';
                    document.getElementById('formGrade').value = customer.grade;
                    document.getElementById('formZipcode').value = customer.zipcode || '';
                    document.getElementById('formAddress').value = customer.address || '';
                    document.getElementById('formBirthday').value = customer.birthday || '';
                    document.getElementById('formGender').value = customer.gender || '';
                    document.getElementById('formMemo').value = customer.memo || '';
                    
                    // 구매 이력 표시
                    this.showPurchaseHistory(customer);
                    
                    document.getElementById('customerFormModal').style.display = 'flex';
                }
            },
            
            viewCustomer: function(id) {
                const customer = this.customers.find(c => c.id === id);
                if (customer) {
                    this.currentEditId = id;
                    this.editCustomer(id);
                }
            },
            
            showPurchaseHistory: function(customer) {
                const section = document.getElementById('purchaseHistorySection');
                const content = document.getElementById('purchaseHistoryContent');
                
                if (customer.purchaseHistory && customer.purchaseHistory.length > 0) {
                    content.innerHTML = `
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>구매일</th>
                                    <th>상품명</th>
                                    <th>수량</th>
                                    <th>금액</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customer.purchaseHistory.map(p => `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td>${p.product}</td>
                                        <td>${p.quantity}</td>
                                        <td>${p.amount.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    section.style.display = 'block';
                } else {
                    content.innerHTML = '<p>구매 이력이 없습니다.</p>';
                    section.style.display = 'block';
                }
            },
            
            saveCustomer: function() {
                const customer = {
                    id: this.currentEditId || Date.now(),
                    name: document.getElementById('formName').value,
                    phone: document.getElementById('formPhone').value,
                    email: document.getElementById('formEmail').value,
                    grade: document.getElementById('formGrade').value,
                    zipcode: document.getElementById('formZipcode').value,
                    address: document.getElementById('formAddress').value,
                    birthday: document.getElementById('formBirthday').value,
                    gender: document.getElementById('formGender').value,
                    memo: document.getElementById('formMemo').value,
                    joinDate: new Date().toISOString().split('T')[0],
                    purchaseCount: 0,
                    totalPurchase: 0,
                    lastPurchase: null,
                    purchaseHistory: []
                };
                
                if (!customer.name || !customer.phone) {
                    alert('필수 항목을 입력해주세요.');
                    return;
                }
                
                if (this.currentEditId) {
                    // 수정
                    const index = this.customers.findIndex(c => c.id === this.currentEditId);
                    if (index !== -1) {
                        const existing = this.customers[index];
                        customer.joinDate = existing.joinDate;
                        customer.purchaseCount = existing.purchaseCount;
                        customer.totalPurchase = existing.totalPurchase;
                        customer.lastPurchase = existing.lastPurchase;
                        customer.purchaseHistory = existing.purchaseHistory;
                        this.customers[index] = customer;
                    }
                } else {
                    // 신규
                    this.customers.unshift(customer);
                }
                
                this.saveCustomersData();
                this.renderTable();
                this.updateStatistics();
                this.closeForm();
                
                alert(this.currentEditId ? '고객 정보가 수정되었습니다.' : '고객이 등록되었습니다.');
            },
            
            deleteCustomer: function(id) {
                if (confirm('삭제하시겠습니까?')) {
                    this.customers = this.customers.filter(c => c.id !== id);
                    this.saveCustomersData();
                    this.renderTable();
                    this.updateStatistics();
                }
            },
            
            resetForm: function() {
                document.getElementById('formName').value = '';
                document.getElementById('formPhone').value = '';
                document.getElementById('formEmail').value = '';
                document.getElementById('formGrade').value = '신규';
                document.getElementById('formZipcode').value = '';
                document.getElementById('formAddress').value = '';
                document.getElementById('formBirthday').value = '';
                document.getElementById('formGender').value = '';
                document.getElementById('formMemo').value = '';
            },
            
            closeForm: function() {
                document.getElementById('customerFormModal').style.display = 'none';
                this.currentEditId = null;
            },
            
            searchCustomers: function() {
                const grade = document.getElementById('customerGrade').value;
                const searchType = document.getElementById('searchType').value;
                const keyword = document.getElementById('searchKeyword').value.toLowerCase();
                const fromDate = document.getElementById('joinDateFrom').value;
                const toDate = document.getElementById('joinDateTo').value;
                
                let filtered = this.customers;
                
                if (grade) {
                    filtered = filtered.filter(c => c.grade === grade);
                }
                
                if (keyword) {
                    filtered = filtered.filter(c => {
                        switch(searchType) {
                            case 'name':
                                return c.name.toLowerCase().includes(keyword);
                            case 'phone':
                                return c.phone.includes(keyword);
                            case 'email':
                                return (c.email || '').toLowerCase().includes(keyword);
                            case 'address':
                                return (c.address || '').toLowerCase().includes(keyword);
                            default:
                                return false;
                        }
                    });
                }
                
                if (fromDate) {
                    filtered = filtered.filter(c => c.joinDate >= fromDate);
                }
                
                if (toDate) {
                    filtered = filtered.filter(c => c.joinDate <= toDate);
                }
                
                this.renderTable(filtered);
            },
            
            resetSearch: function() {
                document.getElementById('customerGrade').value = '';
                document.getElementById('searchType').value = 'name';
                document.getElementById('searchKeyword').value = '';
                document.getElementById('joinDateFrom').value = '';
                document.getElementById('joinDateTo').value = '';
                this.renderTable();
            },
            
            exportExcel: function() {
                console.log('Export to Excel');
                // 엑셀 내보내기 로직
            },
            
            refresh: function() {
                this.loadCustomers();
                this.updateStatistics();
            }
        };
        
        // 전역 노출
        window.CustomerModule = CustomerModule;
    </script>
</body>
</html>
