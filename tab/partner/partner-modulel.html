<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>거래처관리</title>
    <style>
        .partner-container {
            padding: 20px;
        }
        
        .partner-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .partner-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .partner-type-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
        }
        
        .type-supplier { 
            background: #dbeafe; 
            color: #2563eb;
        }
        
        .type-seller { 
            background: #d1fae5; 
            color: #10b981;
        }
        
        .type-partner { 
            background: #fef3c7; 
            color: #f59e0b;
        }
        
        .partner-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .partner-detail-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="partner-container">
        <!-- 거래처 등록 섹션 -->
        <div class="section-container">
            <h2 class="section-title">
                <div class="section-title-text">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    거래처 등록
                </div>
            </h2>
            
            <div class="partner-form">
                <div class="form-row-custom">
                    <div class="form-group" style="width: 150px;">
                        <label>거래처구분 <span class="required">*</span></label>
                        <select id="partnerType" class="form-input-direct">
                            <option value="">선택하세요</option>
                            <option value="공급처">공급처</option>
                            <option value="판매처">판매처</option>
                            <option value="협력사">협력사</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 200px;">
                        <label>거래처명 <span class="required">*</span></label>
                        <input type="text" id="partnerName" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>사업자번호</label>
                        <input type="text" id="partnerBizNo" class="form-input-direct" placeholder="000-00-00000" maxlength="12">
                    </div>
                    <div class="form-group" style="width: 100px;">
                        <label>대표자</label>
                        <input type="text" id="partnerCeo" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>연락처 <span class="required">*</span></label>
                        <input type="tel" id="partnerPhone" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 200px;">
                        <label>이메일</label>
                        <input type="email" id="partnerEmail" class="form-input-direct">
                    </div>
                </div>
                <div class="form-row-custom">
                    <div class="form-group" style="width: 100px;">
                        <label>담당자</label>
                        <input type="text" id="partnerManager" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label>담당자 연락처</label>
                        <input type="tel" id="partnerManagerPhone" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 120px;">
                        <label>거래시작일</label>
                        <input type="date" id="partnerStartDate" class="form-input-direct">
                    </div>
                    <div class="form-group" style="width: 120px;">
                        <label>결제조건</label>
                        <select id="paymentTerms" class="form-input-direct">
                            <option value="현금">현금</option>
                            <option value="30일">30일</option>
                            <option value="60일">60일</option>
                            <option value="협의">협의</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 100px;">
                        <label>거래상태</label>
                        <select id="partnerStatus" class="form-input-direct">
                            <option value="active">거래중</option>
                            <option value="hold">보류</option>
                            <option value="stop">중단</option>
                        </select>
                    </div>
                </div>
                <div class="form-row-custom">
                    <div class="form-group" style="width: 100%;">
                        <label>주소</label>
                        <input type="text" id="partnerAddress" class="form-input-direct">
                    </div>
                </div>
                <div class="form-row-custom">
                    <div class="form-group" style="width: 100%;">
                        <label>메모</label>
                        <textarea id="partnerMemo" class="form-input-direct" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-row-custom">
                    <button class="btn-add-order" onclick="PartnerModule.addPartner()">거래처 추가</button>
                    <button class="btn-reset" onclick="PartnerModule.resetForm()">초기화</button>
                </div>
            </div>
        </div>
        
        <!-- 거래처 통계 -->
        <div class="section-container">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-label">전체 거래처</div>
                    <div class="summary-value" id="totalPartners">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">공급처</div>
                    <div class="summary-value" id="totalSuppliers">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">판매처</div>
                    <div class="summary-value" id="totalSellers">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">협력사</div>
                    <div class="summary-value" id="totalCooperations">0</div>
                </div>
            </div>
        </div>
        
        <!-- 거래처 목록 섹션 -->
        <div class="section-container">
            <h2 class="section-title">
                <div class="section-title-text">
                    거래처 목록
                </div>
                <div class="export-buttons">
                    <button class="export-btn export-excel" onclick="PartnerModule.exportExcel()">엑셀 다운로드</button>
                </div>
            </h2>
            
            <div class="partner-filter">
                <div class="filter-group">
                    <label>구분:</label>
                    <select id="filterType" class="form-input-direct" style="width: 150px;" onchange="PartnerModule.applyFilter()">
                        <option value="">전체</option>
                        <option value="공급처">공급처</option>
                        <option value="판매처">판매처</option>
                        <option value="협력사">협력사</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>상태:</label>
                    <select id="filterStatus" class="form-input-direct" style="width: 120px;" onchange="PartnerModule.applyFilter()">
                        <option value="">전체</option>
                        <option value="active">거래중</option>
                        <option value="hold">보류</option>
                        <option value="stop">중단</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>검색:</label>
                    <input type="text" id="filterKeyword" class="form-input-direct" style="width: 200px;" placeholder="거래처명, 대표자명">
                </div>
                <button class="btn-verify" onclick="PartnerModule.applyFilter()">검색</button>
                <button class="btn-reset" onclick="PartnerModule.resetFilter()">초기화</button>
            </div>
            
            <div class="table-wrapper">
                <table class="order-table" id="partnerTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">번호</th>
                            <th style="width: 80px;">구분</th>
                            <th style="width: 150px;">거래처명</th>
                            <th style="width: 120px;">사업자번호</th>
                            <th style="width: 80px;">대표자</th>
                            <th style="width: 80px;">담당자</th>
                            <th style="width: 120px;">연락처</th>
                            <th style="width: 150px;">이메일</th>
                            <th style="width: 80px;">상태</th>
                            <th style="width: 100px;">등록일</th>
                            <th style="width: 100px;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="partnerTableBody">
                        <tr>
                            <td colspan="11" class="text-center">데이터가 없습니다</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 거래처 상세 모달 -->
    <div id="partnerDetailModal" class="partner-detail-modal">
        <div class="partner-detail-content">
            <h3>거래처 상세 정보</h3>
            <div id="partnerDetailBody">
                <!-- 상세 정보가 여기에 표시됨 -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn-verify" onclick="PartnerModule.closeDetail()">닫기</button>
            </div>
        </div>
    </div>
    
    <script>
        const PartnerModule = {
            partners: [],
            
            init: function() {
                console.log('Partner Module initialized');
                this.loadPartners();
                this.updateStatistics();
                this.setupEventListeners();
                this.setDefaults();
            },
            
            setDefaults: function() {
                document.getElementById('partnerStatus').value = 'active';
                document.getElementById('paymentTerms').value = '현금';
            },
            
            setupEventListeners: function() {
                // 사업자번호 자동 포맷
                document.getElementById('partnerBizNo').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value.length >= 3 && value.length <= 5) {
                        value = value.substring(0, 3) + '-' + value.substring(3);
                    } else if (value.length > 5) {
                        value = value.substring(0, 3) + '-' + value.substring(3, 5) + '-' + value.substring(5, 10);
                    }
                    e.target.value = value;
                });
                
                // 전화번호 자동 포맷
                ['partnerPhone', 'partnerManagerPhone'].forEach(id => {
                    document.getElementById(id).addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^0-9]/g, '');
                        if (value.length >= 4 && value.length <= 7) {
                            if (value.substring(0, 2) === '02') {
                                value = value.substring(0, 2) + '-' + value.substring(2);
                            } else {
                                value = value.substring(0, 3) + '-' + value.substring(3);
                            }
                        } else if (value.length >= 8) {
                            if (value.substring(0, 2) === '02') {
                                if (value.length <= 9) {
                                    value = value.substring(0, 2) + '-' + value.substring(2, 5) + '-' + value.substring(5);
                                } else {
                                    value = value.substring(0, 2) + '-' + value.substring(2, 6) + '-' + value.substring(6, 10);
                                }
                            } else {
                                if (value.length <= 10) {
                                    value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
                                } else {
                                    value = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
                                }
                            }
                        }
                        e.target.value = value;
                    });
                });
            },
            
            addPartner: function() {
                const partner = {
                    id: Date.now(),
                    type: document.getElementById('partnerType').value,
                    name: document.getElementById('partnerName').value,
                    bizNo: document.getElementById('partnerBizNo').value,
                    ceo: document.getElementById('partnerCeo').value,
                    phone: document.getElementById('partnerPhone').value,
                    email: document.getElementById('partnerEmail').value,
                    address: document.getElementById('partnerAddress').value,
                    memo: document.getElementById('partnerMemo').value,
                    manager: document.getElementById('partnerManager').value,
                    managerPhone: document.getElementById('partnerManagerPhone').value,
                    startDate: document.getElementById('partnerStartDate').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    status: document.getElementById('partnerStatus').value,
                    registerDate: new Date().toISOString().split('T')[0]
                };
                
                if (!partner.type || !partner.name || !partner.phone) {
                    alert('필수 항목을 입력해주세요.');
                    return;
                }
                
                // 중복 체크
                const exists = this.partners.find(p => 
                    p.name === partner.name || 
                    (p.bizNo && p.bizNo === partner.bizNo)
                );
                
                if (exists) {
                    alert('이미 등록된 거래처입니다.');
                    return;
                }
                
                this.partners.unshift(partner);
                this.savePartners();
                this.renderTable();
                this.updateStatistics();
                this.resetForm();
                
                alert('거래처가 등록되었습니다.');
            },
            
            resetForm: function() {
                document.getElementById('partnerType').value = '';
                document.getElementById('partnerName').value = '';
                document.getElementById('partnerBizNo').value = '';
                document.getElementById('partnerCeo').value = '';
                document.getElementById('partnerPhone').value = '';
                document.getElementById('partnerEmail').value = '';
                document.getElementById('partnerAddress').value = '';
                document.getElementById('partnerMemo').value = '';
                document.getElementById('partnerManager').value = '';
                document.getElementById('partnerManagerPhone').value = '';
                document.getElementById('partnerStartDate').value = '';
                document.getElementById('paymentTerms').value = '현금';
                document.getElementById('partnerStatus').value = 'active';
            },
            
            loadPartners: function() {
                const saved = localStorage.getItem('partners');
                if (saved) {
                    this.partners = JSON.parse(saved);
                    this.renderTable();
                }
            },
            
            savePartners: function() {
                localStorage.setItem('partners', JSON.stringify(this.partners));
            },
            
            updateStatistics: function() {
                const total = this.partners.length;
                const suppliers = this.partners.filter(p => p.type === '공급처').length;
                const sellers = this.partners.filter(p => p.type === '판매처').length;
                const cooperations = this.partners.filter(p => p.type === '협력사').length;
                
                document.getElementById('totalPartners').textContent = total;
                document.getElementById('totalSuppliers').textContent = suppliers;
                document.getElementById('totalSellers').textContent = sellers;
                document.getElementById('totalCooperations').textContent = cooperations;
            },
            
            renderTable: function(filteredData = null) {
                const tbody = document.getElementById('partnerTableBody');
                const data = filteredData || this.partners;
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center">데이터가 없습니다</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((partner, index) => {
                    const typeBadge = this.getTypeBadge(partner.type);
                    const statusBadge = this.getStatusBadge(partner.status);
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${typeBadge}</td>
                            <td>${partner.name}</td>
                            <td>${partner.bizNo || '-'}</td>
                            <td>${partner.ceo || '-'}</td>
                            <td>${partner.manager || '-'}</td>
                            <td>${partner.phone}</td>
                            <td>${partner.email || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${partner.registerDate}</td>
                            <td>
                                <button class="btn-sm" onclick="PartnerModule.viewDetail(${partner.id})">상세</button>
                                <button class="btn-sm" onclick="PartnerModule.editPartner(${partner.id})">수정</button>
                                <button class="btn-sm btn-danger" onclick="PartnerModule.deletePartner(${partner.id})">삭제</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            getTypeBadge: function(type) {
                const badges = {
                    '공급처': '<span class="partner-type-badge type-supplier">공급처</span>',
                    '판매처': '<span class="partner-type-badge type-seller">판매처</span>',
                    '협력사': '<span class="partner-type-badge type-partner">협력사</span>'
                };
                return badges[type] || '';
            },
            
            getStatusBadge: function(status) {
                const badges = {
                    'active': '<span style="color: #10b981;">거래중</span>',
                    'hold': '<span style="color: #f59e0b;">보류</span>',
                    'stop': '<span style="color: #ef4444;">중단</span>'
                };
                return badges[status] || '';
            },
            
            viewDetail: function(id) {
                const partner = this.partners.find(p => p.id === id);
                if (partner) {
                    const detailHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><strong>거래처명:</strong> ${partner.name}</div>
                            <div><strong>구분:</strong> ${partner.type}</div>
                            <div><strong>사업자번호:</strong> ${partner.bizNo || '-'}</div>
                            <div><strong>대표자:</strong> ${partner.ceo || '-'}</div>
                            <div><strong>연락처:</strong> ${partner.phone}</div>
                            <div><strong>이메일:</strong> ${partner.email || '-'}</div>
                            <div><strong>담당자:</strong> ${partner.manager || '-'}</div>
                            <div><strong>담당자 연락처:</strong> ${partner.managerPhone || '-'}</div>
                            <div><strong>거래시작일:</strong> ${partner.startDate || '-'}</div>
                            <div><strong>결제조건:</strong> ${partner.paymentTerms}</div>
                            <div><strong>거래상태:</strong> ${this.getStatusBadge(partner.status)}</div>
                            <div><strong>등록일:</strong> ${partner.registerDate}</div>
                            <div style="grid-column: 1 / -1;"><strong>주소:</strong> ${partner.address || '-'}</div>
                            <div style="grid-column: 1 / -1;"><strong>메모:</strong> ${partner.memo || '-'}</div>
                        </div>
                    `;
                    document.getElementById('partnerDetailBody').innerHTML = detailHtml;
                    document.getElementById('partnerDetailModal').style.display = 'flex';
                }
            },
            
            closeDetail: function() {
                document.getElementById('partnerDetailModal').style.display = 'none';
            },
            
            editPartner: function(id) {
                const partner = this.partners.find(p => p.id === id);
                if (partner) {
                    // 폼에 데이터 채우기
                    document.getElementById('partnerType').value = partner.type;
                    document.getElementById('partnerName').value = partner.name;
                    document.getElementById('partnerBizNo').value = partner.bizNo;
                    document.getElementById('partnerCeo').value = partner.ceo;
                    document.getElementById('partnerPhone').value = partner.phone;
                    document.getElementById('partnerEmail').value = partner.email;
                    document.getElementById('partnerAddress').value = partner.address;
                    document.getElementById('partnerMemo').value = partner.memo;
                    document.getElementById('partnerManager').value = partner.manager;
                    document.getElementById('partnerManagerPhone').value = partner.managerPhone;
                    document.getElementById('partnerStartDate').value = partner.startDate;
                    document.getElementById('paymentTerms').value = partner.paymentTerms;
                    document.getElementById('partnerStatus').value = partner.status;
                    
                    // 기존 데이터 삭제
                    this.partners = this.partners.filter(p => p.id !== id);
                    
                    // 스크롤 상단으로
                    window.scrollTo(0, 0);
                    alert('수정할 내용을 입력하고 다시 추가해주세요.');
                }
            },
            
            deletePartner: function(id) {
                if (confirm('삭제하시겠습니까?')) {
                    this.partners = this.partners.filter(p => p.id !== id);
                    this.savePartners();
                    this.renderTable();
                    this.updateStatistics();
                }
            },
            
            applyFilter: function() {
                const type = document.getElementById('filterType').value;
                const status = document.getElementById('filterStatus').value;
                const keyword = document.getElementById('filterKeyword').value.toLowerCase();
                
                let filtered = this.partners;
                
                if (type) {
                    filtered = filtered.filter(p => p.type === type);
                }
                if (status) {
                    filtered = filtered.filter(p => p.status === status);
                }
                if (keyword) {
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(keyword) ||
                        (p.ceo && p.ceo.toLowerCase().includes(keyword))
                    );
                }
                
                this.renderTable(filtered);
            },
            
            resetFilter: function() {
                document.getElementById('filterType').value = '';
                document.getElementById('filterStatus').value = '';
                document.getElementById('filterKeyword').value = '';
                this.renderTable();
            },
            
            exportExcel: function() {
                console.log('Export to Excel');
                // 엑셀 내보내기 로직
            },
            
            refresh: function() {
                this.loadPartners();
                this.updateStatistics();
            }
        };
        
        // 전역 노출
        window.PartnerModule = PartnerModule;
